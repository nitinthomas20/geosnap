<main class="app-layout">
  @let location = gameService.currentLocation();
  @let locations = locationService.locations();
  @let result = lastResult();

  <header class="game-header">
    <div class="logo">GEOSNAP</div>
    <div class="score-board">
      <div class="score-item">
        <span class="label">SCORE</span>
        <span class="value">{{ gameService.totalScore() }}</span>
      </div>
      <div class="score-item">
        <span class="label">ROUND</span>
        <span class="value">{{ gameService.currentRoundIndex() + 1 }} / {{ locations.length }}</span>
      </div>
    </div>
  </header>

  <div class="game-container">
    @if (!showResult()) {
      <div class="image-section">
        <div class="image-viewport"
        (mousedown)="startDrag($event)"
        (mousemove)="onDrag($event)"
        (mouseup)="endDrag()"
        (mouseleave)="endDrag()"
        [class.dragging]="isDragging()"
>
            <img 
            [ngSrc]="location.imageUrl"
            [style.transform]="imageTransform()"
            width="800"
            height="800"
            priority 
            class="zoomable-image"
            draggable="false"
            />
            <div class="zoom-controls-bar">
            <button (click)="zoomIn()" title="Zoom In">âž•</button>
            <button (click)="zoomOut()" title="Zoom Out">âž–</button>
            <button (click)="resetZoom()" title="Reset view">âŒ–</button>
            
            <span class="zoom-label">{{ (zoomLevel() * 100).toFixed(0) }}%</span>

        </div>
      </div>
      </div>
       <div class="control-section" [class.collapsed]="isCollapsed()">
        <div class="control-header" (click)="isCollapsed.set(!isCollapsed())">
          <span class="toggle-icon">
            {{ isCollapsed() ? 'ðŸ”¼' : 'ðŸ”½' }}
          </span>
        </div>
      <div class="control-content-wrapper">
        <div class="sidebar-content">
          <button class="outline-btn hint-btn" (click)="showHint()">Hint</button>
          @if (hint()) {
            <p class="hint-text"><strong>Hint:</strong> {{ location.description }}</p>
          }

          <div class="inputs">
            <div class="input-group">
              <label>LATITUDE</label>
              <input type="number" [(ngModel)]="userLat" placeholder="0.0000" />
            </div>
            <div class="input-group">
              <label>LONGITUDE</label>
              <input type="number" [(ngModel)]="userLng" placeholder="0.0000" />
            </div>
          </div>

          <button class="main-btn submit-btn" (click)="handleGuess()">
            {{ gameService.isGameOver() ? 'Finish Game' : 'Submit Coordinates' }}
          </button>
        </div>
      </div>
    </div>
    } @else {
      <app-map-view
        [userCoords]="{ lat: userLat(), lng: userLng() }"
        [actualCoords]="{ lat: location.lat, lng: location.lng }"
        [distance]="result?.distance ?? 0" 
        [points]="result?.points ?? 0"
        (next)="resetRound()"
      ></app-map-view>
    }
  </div>
</main>